pipeline {
    agent none
    
    environment {
        DOCKER_IMAGE_NAME = 'rs-school-devops'
    }

    stages {
        stage('Setup & Test') {
            agent {
                docker {
                    image 'docker:24-dind'
                    args '--privileged -v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            steps {
                echo '--------------------------------'
                echo 'Setting up....'
                sh '''
                    # Install required packages for Alpine Linux (docker:dind is Alpine-based)
                    apk add --no-cache python3 py3-pip python3-dev curl bash git
                    python3 -m venv .venv
                    .venv/bin/pip install --upgrade pip
                    
                    # Install Helm
                    curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
                    helm version
                    
                    # Install kubectl
                    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                    chmod +x kubectl
                    mv kubectl /usr/local/bin/
                    kubectl version --client
                    
                    # Verify Docker is working
                    docker --version
                    docker info
                '''
                
                echo '--------------------------------'
                echo 'Checking out code....'
                checkout scm
                
                echo '--------------------------------'
                echo 'Testing....'
                sh '''
                    .venv/bin/pip install -r app/requirements.txt
                    cd app && ../.venv/bin/python -m unittest discover
                '''
                
                echo '--------------------------------'
                echo 'Security Scanning....'
                // Add security scanning tools here
                echo 'Security scan completed'
            }
        }
        
        stage('Build Docker Image') {
            agent {
                docker {
                    image 'docker:24-dind'
                    args '--privileged -v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            steps {
                echo '--------------------------------'
                echo 'Checking out code for build....'
                checkout scm
                
                echo 'Building Docker Image....'
                script {
                    def gitCommitShort = sh(script: 'git rev-parse --short HEAD', returnStdout: true).trim()
                    env.GIT_COMMIT_SHORT = gitCommitShort
                    
                    echo "Building with version: ${gitCommitShort}"
                    
                    sh """
                        docker build -t ${env.DOCKER_IMAGE_NAME}:${gitCommitShort} ./app
                        docker tag ${env.DOCKER_IMAGE_NAME}:${gitCommitShort} ${env.DOCKER_IMAGE_NAME}:latest
                    """
                    
                    // Store image for later use
                    env.DOCKER_IMAGE = "${env.DOCKER_IMAGE_NAME}:${gitCommitShort}"
                }
            }
        }
        
        stage('Push Docker Image') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                    branch 'task-6'
                }
            }
            agent {
                docker {
                    image 'docker:24-dind'
                    args '--privileged -v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            steps {
                echo '--------------------------------'
                echo 'Pushing Docker Image to Docker Hub....'
                withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', 
                                                 passwordVariable: 'DOCKER_PASSWORD', 
                                                 usernameVariable: 'DOCKER_USERNAME')]) {
                    script {
                        sh '''
                            # Login to Docker Hub
                            echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin
                            
                            # Tag and push with commit hash
                            docker tag ${DOCKER_IMAGE_NAME}:${GIT_COMMIT_SHORT} ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}:${GIT_COMMIT_SHORT}
                            docker tag ${DOCKER_IMAGE_NAME}:${GIT_COMMIT_SHORT} ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}:latest
                            
                            # Push images
                            docker push ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}:${GIT_COMMIT_SHORT}
                            docker push ${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}:latest
                            
                            # Logout
                            docker logout
                        '''
                    }
                }
            }
        }
        
        stage('Deploy to Kubernetes') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                    branch 'task-6'
                }
            }
            agent {
                docker {
                    image 'docker:24-dind'
                    args '--privileged -v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            steps {
                echo '--------------------------------'
                echo 'Checking out code for deployment....'
                checkout scm
                
                echo 'Installing kubectl and helm....'
                sh '''
                    # Install kubectl
                    apk add --no-cache curl
                    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                    chmod +x kubectl
                    mv kubectl /usr/local/bin/
                    
                    # Install Helm
                    curl https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3 | bash
                '''
                
                echo 'Deploying with Helm....'
                withCredentials([usernamePassword(credentialsId: 'dockerhub-credentials', 
                                                 passwordVariable: 'DOCKER_PASSWORD', 
                                                 usernameVariable: 'DOCKER_USERNAME')]) {
                    sh '''
                        DOCKER_IMAGE="${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}:${GIT_COMMIT_SHORT}"
                        
                        echo "Deploying ${DOCKER_IMAGE} to Kubernetes using Helm..."
                        
                        # Deploy using Helm
                        helm upgrade --install rs-school-devops ./k8s/helm/nginx/ \
                            --set image.repository="${DOCKER_USERNAME}/${DOCKER_IMAGE_NAME}" \
                            --set image.tag="${GIT_COMMIT_SHORT}" \
                            --wait \
                            --timeout=300s
                        
                        # Show deployment status
                        kubectl get deployments
                        kubectl get services
                        kubectl get pods
                    '''
                }
            }
        }
        
        stage('Verify Deployment') {
            when {
                anyOf {
                    branch 'main'
                    branch 'master'
                    branch 'task-6'
                }
            }
            agent {
                docker {
                    image 'docker:24-dind'
                    args '--privileged -v /var/run/docker.sock:/var/run/docker.sock'
                }
            }
            steps {
                echo '--------------------------------'
                echo 'Verifying Kubernetes Deployment....'
                sh '''
                    # Install kubectl and python
                    apk add --no-cache curl python3 py3-pip
                    curl -LO "https://dl.k8s.io/release/$(curl -L -s https://dl.k8s.io/release/stable.txt)/bin/linux/amd64/kubectl"
                    chmod +x kubectl
                    mv kubectl /usr/local/bin/
                    
                    # Wait for deployment to be ready
                    kubectl wait --for=condition=available --timeout=300s deployment/rs-school-devops
                    
                    # Get service information
                    kubectl get service rs-school-devops-nginx-service || kubectl get service rs-school-devops-service || echo "Service not found"
                    
                    # Get pod status
                    kubectl get pods -l app=rs-school-devops
                    
                    # Test the service (basic verification)
                    python3 -m pip install requests
                    python3 -c "
import time
print('Deployment verification complete!')
print('Application has been successfully deployed to Kubernetes')

# Check pod logs for any immediate issues
import subprocess
try:
    result = subprocess.run(['kubectl', 'logs', '-l', 'app=rs-school-devops', '--tail=10'], 
                          capture_output=True, text=True, timeout=30)
    print('Recent application logs:')
    print(result.stdout)
except Exception as e:
    print(f'Could not retrieve logs: {e}')
"
                '''
            }
        }
    }
    
    post {
        always {
            echo 'Pipeline completed!'
        }
        success {
            echo 'Pipeline succeeded!'
        }
        failure {
            echo 'Pipeline failed!'
        }
    }
}